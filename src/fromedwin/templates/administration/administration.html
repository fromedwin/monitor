{% extends 'application.html' %}
{% load static socialaccount account %}
{% block html_head_title %}Administration - FromEdwin{% endblock %}
{% block content %}
  <header class="pb-4">
    <h1 class="text-3xl font-bold leading-tight text-gray-900">Administration</h1>
  </header>
  {% if email_success %}
    <div class="rounded-md bg-green-50 p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-green-400"
               viewBox="0 0 20 20"
               fill="currentColor"
               aria-hidden="true">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-green-800">The test email was successfully sent to {{ user.email }}</p>
        </div>
      </div>
    </div>
  {% endif %}
  <div class="pt-8 pb-5 border-b border-gray-200 sm:flex sm:items-center sm:justify-between">
    <h3 class="text-lg leading-6 font-medium text-gray-900">Links</h3>
  </div>
  <a href="/"
     class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
     role="menuitem"
     tabindex="-1"
     id="user-menu-item-2">Website</a>
  <a href="/admin/"
     target="_blank"
     class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
     role="menuitem"
     tabindex="-1"
     id="user-menu-item-2">
    <img src="{% static 'logos/django-icon.svg' %}"
         alt=""
         style="height: 1.2em;
                display: inline;
                margin-right: 8px" />
    Django administration
  </a>
  <a href="{{ settings.CELERY_BROKER_UI_URL }}"
     target="_blank"
     class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
     role="menuitem"
     tabindex="-1"
     id="user-menu-item-2">
    <img src="{% static 'logos/rabbitmq-icon.svg' %}"
         alt=""
         style="height: 1.2em;
                display: inline;
                margin-right: 8px" />
    Rabbit MQ
  </a>
  <a href="{{ settings.INFLUXDB_UI_URL }}"
     target="_blank"
     class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
     role="menuitem"
     tabindex="-1"
     id="user-menu-item-2">
    <img src="{% static 'logos/influxdb-icon.svg' %}"
         alt=""
         style="height: 1.2em;
                display: inline;
                margin-right: 8px" />
    Influx DB
  </a>
  <div class="pt-8 pb-5 border-b border-gray-200 sm:flex sm:items-center sm:justify-between">
    <h3 class="text-lg leading-6 font-medium text-gray-900">Workers</h3>
  </div>
  <div class="flex flex-col pt-5">
    <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
      <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
        <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  IP, UUID
                </th>
                <th scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Last seen
                </th>
                <th scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Features
                </th>
                <th scope="col"
                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Config</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for server in servers %}
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900"></div>
                        <div class="text-sm text-gray-500">{{ server.uuid }}</div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">{{ server.last_seen_from }}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-emerald-100 text-emerald-800">
                      Prometheus
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="/clients/prometheus/{{ server.uuid }}"
                       class="text-indigo-600 hover:text-indigo-900">Prometheus</a> -
                    <a href="/clients/alertmanager/{{ server.uuid }}"
                       class="text-indigo-600 hover:text-indigo-900">Alertmanager</a> -
                    <a href="/clients/alerts/{{ server.uuid }}"
                       class="text-indigo-600 hover:text-indigo-900">Alerts</a> -
                    <a href="/admin/workers/server/{{ server.id }}/change/"
                       class="text-indigo-600 hover:text-indigo-900">Edit</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="bg-white py-6 sm:py-12" x-data="administrationStats()">
    <div class="mx-auto max-w-7xl px-1 lg:px-1">
      <div class="mx-auto max-w-2xl lg:max-w-none">
        <!-- Timer and Refresh Controls -->
        <div class="flex items-center justify-between text-xs text-gray-500 mb-4">
          <span class="flex items-center">
            <svg class="w-3 h-3 mr-1"
                 fill="none"
                 stroke="currentColor"
                 viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z">
              </path>
            </svg>
            Auto-refresh in <span x-text="timeLeft" class="pl-1 font-medium"></span>s
          </span>
          <button @click="refreshStats()"
                  :disabled="loading"
                  class="text-gray-400 hover:text-gray-600 disabled:opacity-50 transition-colors text-xs">
            <span x-show="!loading" class="flex items-center">
              <svg class="w-3 h-3 mr-1"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
              </svg>
              Refresh
            </span>
            <span x-show="loading" class="flex items-center">
              <svg class="w-3 h-3 mr-1 animate-spin"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
              </svg>
              Loading...
            </span>
          </button>
        </div>
        <!-- Statistics Container with Progress Top Border -->
        <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white">
          <!-- Progress Bar as Top Border -->
          <div class="w-full bg-gray-300 h-0.5">
            <div class="bg-emerald-500 h-0.5 transition-all duration-1000 ease-linear"
                 :style="`width: ${progress}%`"></div>
          </div>
          <!-- Statistics Grid -->
          <dl class="grid grid-cols-1 gap-0.5 text-center sm:grid-cols-2 lg:grid-cols-4">
            <div class="flex flex-col bg-gray-400/5 p-8">
              <dt class="text-sm font-semibold leading-6 text-gray-600">General queue</dt>
              <dd class="order-first text-3xl font-semibold tracking-tight text-gray-900"
                  x-text="stats.fromedwin_queue !== null ? Math.round(stats.fromedwin_queue) : 'No queue'">
              </dd>
            </div>
            <div class="flex flex-col bg-gray-400/5 p-8">
              <dt class="text-sm font-semibold leading-6 text-gray-600">Lighthouse msg in queue</dt>
              <dd class="order-first text-3xl font-semibold tracking-tight text-gray-900"
                  x-text="stats.lighthouse_queue !== null ? Math.round(stats.lighthouse_queue) : 'No queue'">
              </dd>
            </div>
            <div class="flex flex-col bg-gray-400/5 p-8">
              <dt class="text-sm font-semibold leading-6 text-gray-600">Users</dt>
              <dd class="order-first text-3xl font-semibold tracking-tight text-gray-900"
                  x-text="stats.users_count">
              </dd>
            </div>
            <div class="flex flex-col bg-gray-400/5 p-8">
              <dt class="text-sm font-semibold leading-6 text-gray-600">Availability URLs</dt>
              <dd class="order-first text-3xl font-semibold tracking-tight text-gray-900"
                  x-text="stats.url_count">
              </dd>
            </div>
            <div class="flex flex-col bg-gray-400/5 p-8">
              <dt class="text-sm font-semibold leading-6 text-gray-600">Current version</dt>
              <dd class="order-first text-3xl font-semibold tracking-tight text-gray-900">
                {{ settings.VERSION.0 }}.{{ settings.VERSION.1 }}.{{ settings.VERSION.2 }}
              </dd>
            </div>
            <div class="flex flex-col bg-gray-400/5 p-8">
              <dt class="text-sm font-semibold leading-6 text-gray-600">Lighthouse workers</dt>
              <dd class="order-first text-3xl font-semibold tracking-tight text-gray-900"
                  x-text="stats.lighthouse_worker !== null ? Math.round(stats.lighthouse_worker) : 'Unknown'">
              </dd>
            </div>
            <div class="flex flex-col bg-gray-400/5 p-8">
              <dt class="text-sm font-semibold leading-6 text-gray-600">Celery workers</dt>
              <dd class="order-first text-3xl font-semibold tracking-tight text-gray-900"
                  x-text="stats.celery_worker !== null ? Math.round(stats.celery_worker) : 'Unknown'">
              </dd>
            </div>
            <div class="flex flex-col bg-gray-400/5 p-8">
              <dt class="text-sm font-semibold leading-6 text-gray-600">Prometheus workers</dt>
              <dd class="order-first text-3xl font-semibold tracking-tight text-gray-900"
                  x-text="stats.prometheus_workers">
              </dd>
            </div>
          </dl>
        </div>
      </div>
    </div>
  </div>
  <div class="pt-4 pb-2 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-medium text-gray-600">
        Timings:
        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium {% if settings.TIMINGS.BEAT_SCHEDULE_INTERVAL_SECONDS == 60 %}bg-blue-100 text-blue-700 {% elif settings.TIMINGS.BEAT_SCHEDULE_INTERVAL_SECONDS == 10 %}bg-green-100 text-green-700 {% else %}bg-yellow-100 text-yellow-700{% endif %}">
          {% if settings.TIMINGS.BEAT_SCHEDULE_INTERVAL_SECONDS == 60 %}
            SLOW
          {% elif settings.TIMINGS.BEAT_SCHEDULE_INTERVAL_SECONDS == 10 %}
            FAST
          {% else %}
            CUSTOM
          {% endif %}
        </span>
      </h3>
      <div class="text-xs text-gray-400">
        {% if settings.TIMINGS.BEAT_SCHEDULE_INTERVAL_SECONDS == 10 %}
          Dev
        {% elif settings.TIMINGS.BEAT_SCHEDULE_INTERVAL_SECONDS == 60 %}
          Prod
        {% else %}
          Custom
        {% endif %}
      </div>
    </div>
    <div class="mt-2 flex items-center space-x-4 text-xs">
      <span class="text-gray-500">
        <span class="font-medium">Beat:</span>
        {% if settings.TIMINGS.BEAT_SCHEDULE_INTERVAL_SECONDS %}
          {{ settings.TIMINGS.BEAT_SCHEDULE_INTERVAL_SECONDS }}s
        {% else %}
          N/A
        {% endif %}
      </span>
      <span class="text-gray-500">
        <span class="font-medium">Report:</span>
        {% if settings.TIMINGS.REPORT_INTERVAL_DAYS %}
          {{ settings.TIMINGS.REPORT_INTERVAL_DAYS }}d
        {% else %}
          N/A
        {% endif %}
      </span>
      <span class="text-gray-500">
        <span class="font-medium">LH:</span>
        {% if settings.TIMINGS.LIGHTHOUSE_INTERVAL_HOURS %}
          {{ settings.TIMINGS.LIGHTHOUSE_INTERVAL_HOURS }}h
        {% else %}
          N/A
        {% endif %}
      </span>
      <span class="text-gray-500">
        <span class="font-medium">Sitemap:</span>
        {% if settings.TIMINGS.SITEMAP_INTERVAL_HOURS %}
          {{ settings.TIMINGS.SITEMAP_INTERVAL_HOURS }}h
        {% else %}
          N/A
        {% endif %}
      </span>
    </div>
  </div>
  <div class="pt-8 pb-5 border-b border-gray-200 sm:flex sm:items-center sm:justify-between">
    <h3 class="text-lg leading-6 font-medium text-gray-900">Others</h3>
  </div>
  <a href="{% url 'test_email' %}"
     class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
     role="menuitem"
     tabindex="-1"
     id="user-menu-item-2">Test Email</a>
  <a href="/metrics"
     class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
     role="menuitem"
     tabindex="-1"
     id="user-menu-item-2">Prometheus django metrics</a>
  <script>
function administrationStats() {
    return {
        stats: {
            fromedwin_queue: {% if stats.fromedwin_queue != None %}{{ stats.fromedwin_queue }}{% else %}null{% endif %},
            lighthouse_queue: {% if stats.lighthouse_queue != None %}{{ stats.lighthouse_queue }}{% else %}null{% endif %},
            users_count: {{ stats.users_count }},
            url_count: {{ stats.url_count }},
            lighthouse_worker: {% if stats.lighthouse_worker is not None %}{{ stats.lighthouse_worker }}{% else %}null{% endif %},
            celery_worker: {% if stats.celery_worker is not None %}{{ stats.celery_worker }}{% else %}null{% endif %},
            prometheus_workers: {{ stats.prometheus_workers }}
        },
        loading: false,
        timeLeft: 15,
        progress: 100,
        intervalId: null,
        refreshIntervalId: null,

        init() {
            this.startProgressBar();
            this.startAutoRefresh();
        },

        startProgressBar() {
            this.intervalId = setInterval(() => {
                if (this.timeLeft > 0) {
                    this.timeLeft--;
                    this.progress = (this.timeLeft / 15) * 100;
                } else {
                    this.refreshStats();
                }
            }, 1000);
        },

        startAutoRefresh() {
            this.refreshIntervalId = setInterval(() => {
                this.refreshStats();
            }, 15000);
        },

        async refreshStats() {
            if (this.loading) return;

            this.loading = true;
            try {
                const response = await fetch('/api/administration/stats/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    }
                });

                if (response.ok) {
                    const newStats = await response.json();
                    this.stats = newStats;
                    this.resetProgress();
                } else {
                    console.error('Failed to fetch stats:', response.status);
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
            } finally {
                this.loading = false;
            }
        },

        resetProgress() {
            this.timeLeft = 15;
            this.progress = 100;
        },

        getCSRFToken() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            return csrfToken ? csrfToken.value : '';
        },

        destroy() {
            if (this.intervalId) clearInterval(this.intervalId);
            if (this.refreshIntervalId) clearInterval(this.refreshIntervalId);
        }
    }
}
  </script>
{% endblock %}
