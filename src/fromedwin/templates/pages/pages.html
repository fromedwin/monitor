{% extends 'projects/project_view.html' %}
{% load static socialaccount account tailwind_tags fromedwin_tags humanize %}

{% block html_head_title %}Performances - {{ project.title }} - FromEdwin{% endblock %}

{% block javascript %}
<script src="{% static 'echarts/echarts.min.js' %}"></script>
<script>
  function initEchartGauge(element) {
    var score = parseFloat(element.getAttribute('data-score'));
    var red = 'rgb(220, 38, 38)';
    var green = 'rgb(5, 150, 105)';
    var orange = 'rgb(217, 119, 6)';
    var grey = 'rgb(200, 200, 200)';
    var animation = window.location.hash !== '#noanimations';

      // Echarts options
      var serie = {
        startAngle: 90,
        endAngle: -270,
        type: 'gauge',
        progress: {
          show: true,
          width: 3,
        },
        axisLine: {
          lineStyle: {
            width: 3,
          },
        },
        axisTick: {
          show: false
        },
        splitLine: {
          show: false
        },
        axisLabel: {
          show: false
        },
        pointer: {
          show: false
        },
        anchor: {
          show: false
        },
        title: {
          show: false
        },
      };

      // Is lighthouse failed measuring score
      if (isNaN(score)) {
        if (element.getAttribute('data-score') == '--') {
          serie = Object.assign({}, serie, {
            title: {
              offsetCenter: [0, '0%'],
              fontSize: 16,
              color: grey,
            },
            itemStyle: {
              color: grey,
            },
            detail: {
              show: false,
            },
            data: [
              {
                value: 0,
                name: '--',
              }
            ]
          });
        } else {

          serie = Object.assign({}, serie, {
            title: {
              offsetCenter: [0, '0%'],
              fontSize: 16,
              color: red,
            },
            itemStyle: {
              color: red,
            },
            detail: {
              show: false,
            },
            data: [
              {
                value: 100,
                name: '?',
              }
            ]
          });
        }
      } else {
        // We read data-score attribute to get score
        var value = Math.round(score*100);

        var color = red;
        if (value >= 90) {
          color = green;
        } else if (value >= 50) {
          color = orange;
        }

        serie = Object.assign({}, serie, {
          detail: {
            valueAnimation: animation,
            fontSize: 12,
            color: color,
            offsetCenter: [0, '0%'],
          },
          itemStyle: {
            color: color,
          },
          data: [
            {
              value: value,
            }
          ]
        });
      }

      // Init echarts with options generated with serie data
      var myChart = echarts.init(element, null, {renderer: 'svg'});
      serie && myChart.setOption({
        series: [ serie ],
        animation: animation,
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    var gauges = document.getElementsByClassName('echartgauge');
    [...gauges].forEach((element) => {
      // Only initialize when element is visible on screen
      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            initEchartGauge(element);
            obs.unobserve(element); // Only trigger once per element
          }
        });
      }, { threshold: 0.1 });
      observer.observe(element);
    });
  });
</script>
{% endblock %}

{% block subsection %}
<header class="pb-4">
  <h1 class="text-3xl font-bold leading-tight text-gray-900 relative pl-16 pt-2 pb-8">
    <div class="absolute top-0 left-0 flex h-12 w-12 items-center justify-center rounded-lg bg-emerald-600">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-8 w-8 text-white">
        <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" />
      </svg>
    </div>
    Pages
  </h1>
</header>
<div class="pt-4">
    <div class="pb-5 border-b border-gray-200 sm:flex sm:items-center sm:justify-between">
      <h3 class="text-lg leading-6 font-medium text-gray-900">
        Web pages ({{ pages_count }})
      </h3>
    </div>
    <div class="flex flex-col mt-4">

      {% for page in pages %}
      <div class="pt-4 pb-8 performance_tree">

        
        {% with report=page.lighthouse_report.first %}
        <div class="flex items-start gap-2">
          {% if report and report.screenshot %}
          <div class="flex items-center shrink-0">
            <img
              x-data="{ visible: false }"
              x-intersect="visible = true"
              :src="visible ? '{{ report.screenshot.url }}' : ''"
              class="w-[100px] h-[70px] bg-gray-200"
              alt=""
            />
          </div>
          {% else %}
          <div class="flex items-center shrink-0">
            <div class="w-[100px] h-[70px] bg-gray-200 rounded-md"></div>
          </div>
          {% endif %}
          <div class="px-3 text-sm font-medium text-gray-900 flex-grow flex flex-col items-start">

            <p class="text-sm font-bold">
              {{ page.title }}</page>
            </p>
            <p><a href="{{ page.url }}">
              <span class="text-gray-400 text-sm pr-1">{{ page.url }}</span>{{ child.path_without_parent }}
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 inline-block ml-1 text-gray-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
              </svg></a>
            </p>
            <p class="text-sm font-normal">
              {{ page.description }}</page>
            </p>
          </div>
          <div class="flex flex-row px-3 py-2 items-center shrink-0">
            {% if report %}
            <a href="{% url 'project_performances_report_viewer' report.page.project.id report.id %}" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="{{ report.score_performance }}"></div>
              <p class="text-xs">Performances</p>
            </a>

            <a href="{% url 'project_performances_report_viewer' report.page.project.id report.id %}#accessibility" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="{{ report.score_accessibility }}"></div>
              <p class="text-xs">Accessibility</p>
            </a>
            <a href="{% url 'project_performances_report_viewer' report.page.project.id report.id %}#best-practices" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="{{ report.score_best_practices }}"></div>
              <p class="text-xs">Best practices</p>
            </a>
            <a href="{% url 'project_performances_report_viewer' report.page.project.id report.id %}#seo" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="{{ report.score_seo }}"></div>
              <p class="text-xs">SEO</p>
            </a>
            <a href="{% url 'project_performances_report_viewer' report.page.project.id report.id %}#pwa" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="{{ report.score_pwa }}"></div>
              <p class="text-xs">PWA</p>
            </a>

            {% else %}
            <div class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="--"></div>
              <p class="text-xs">Performances</p>
            </div>

            <div class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="--"></div>
              <p class="text-xs">Accessibility</p>
            </div>
            <div class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="--"></div>
              <p class="text-xs">Best practices</p>
            </div>
            <div class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="--"></div>
              <p class="text-xs">SEO</p>
            </div>
            <div class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
              <div class="echartgauge" data-score="--"></div>
              <p class="text-xs">PWA</p>
            </div>
            {% endif %}
          </div>
          <div class="flex items-center space-x-1">

            <!-- DROPDOWNM MENU-->
            <div class="relative inline-block text-left" x-data="{ open: false }">
              <div>
                <button
                  id="performance-{{ app }}-button"
                  type="button"
                  class="flex items-center rounded-full text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 focus:ring-offset-gray-100 px-1 py-1"
                  aria-expanded="true"
                  aria-haspopup="true"
                  @click="open = !open"
                  @keydown.escape="open = false"
                >
                  <span class="sr-only">Open options</span>
                  <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" />
                  </svg>
                </button>
              </div>
              <div
                id="performance-{{ app }}-dropdown"
                class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
                role="menu"
                aria-orientation="vertical"
                aria-labelledby="menu-button"
                tabindex="-1"
                x-show="open"
                x-transition
                @click.away="open = false"
                style="display: none;"
              >
                <div class="py-1" role="none">
                  {% if report %}
                  <a href="{% url 'project_performances_report_viewer' report.page.project.id report.id %}" class="text-gray-700 block px-4 py-2 text-sm" role="menuitem" tabindex="-1" id="menu-item-1">See Report</a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>


        <div class="border-b border-gray-200 pb-5">
          <div class="flex flex-row gap-2 items-center justify-between">
            <p class="text-xs text-gray-500 mt-2">
              Last report: {{ page.lighthouse_report.last.creation_date|naturaltime }}
            </p>
            {% if page.lighthouse_last_request > page.lighthouse_report.last.creation_date %}
            <p class="text-xs text-gray-500 mt-2">Status: Queued</p>
            {% elif page.next_lighthouse_run < 0 %}
            <p class="text-xs text-gray-500 mt-2">
              Will be picked soon
            </p>
            {% else %}
            <p class="text-xs text-gray-500 mt-2">
              Next run in {{ page.next_lighthouse_run|timeuntil }}
            </p>
            {% endif %}
          </div>
        </div>
        <!--  -->
        {% endwith %}

        <div class="flex flex-row gap-2 items-center justify-between">
          <!-- Previous Reports Section -->
          {% if page.lighthouse_report.all.count > 1 %}
          <div x-data="{ showPrevious: false }" class="w-full">
            <button
              @click="showPrevious = !showPrevious"
              class="flex items-center text-xs text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 rounded px-2 py-1"
            >
              <span>Show previous reports ({{ page.lighthouse_report.all.count|add:"-1" }})</span>
              <svg
                class="ml-1 h-3 w-3 transform transition-transform"
                :class="{ 'rotate-180': showPrevious }"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            
            <div
              x-show="showPrevious"
              x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform scale-95"
              x-transition:enter-end="opacity-100 transform scale-100"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform scale-100"
              x-transition:leave-end="opacity-0 transform scale-95"
              class="mt-3 space-y-3"
              style="display: none;"
            >
                             {% for old_report in page.lighthouse_report.all|dictsort:"creation_date"|slice:"::-1" %}
                 {% if old_report != page.lighthouse_report.first %}
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                  <div class="flex items-center justify-between mb-2">
                    <p class="text-xs font-medium text-gray-600">
                      Report from {{ old_report.creation_date|naturaltime }}
                    </p>
                    <a href="{% url 'project_performances_report_viewer' old_report.page.project.id old_report.id %}" 
                       class="text-xs text-emerald-600 hover:text-emerald-800">
                      View Report
                    </a>
                  </div>
                  
                                     <div class="grid grid-cols-5 gap-2">
                     <a href="{% url 'project_performances_report_viewer' old_report.page.project.id old_report.id %}" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
                       <div class="echartgauge" data-score="{{ old_report.score_performance }}"></div>
                       <p class="text-xs text-gray-500 mt-1">Perf</p>
                     </a>
                     <a href="{% url 'project_performances_report_viewer' old_report.page.project.id old_report.id %}#accessibility" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
                       <div class="echartgauge" data-score="{{ old_report.score_accessibility }}"></div>
                       <p class="text-xs text-gray-500 mt-1">A11y</p>
                     </a>
                     <a href="{% url 'project_performances_report_viewer' old_report.page.project.id old_report.id %}#best-practices" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
                       <div class="echartgauge" data-score="{{ old_report.score_best_practices }}"></div>
                       <p class="text-xs text-gray-500 mt-1">BP</p>
                     </a>
                     <a href="{% url 'project_performances_report_viewer' old_report.page.project.id old_report.id %}#seo" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
                       <div class="echartgauge" data-score="{{ old_report.score_seo }}"></div>
                       <p class="text-xs text-gray-500 mt-1">SEO</p>
                     </a>
                     <a href="{% url 'project_performances_report_viewer' old_report.page.project.id old_report.id %}#pwa" class="text-sm text-gray-900 flex flex-col justify-center align-middle text-center px-1">
                       <div class="echartgauge" data-score="{{ old_report.score_pwa }}"></div>
                       <p class="text-xs text-gray-500 mt-1">PWA</p>
                     </a>
                   </div>
                </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

      </div>
      {% endfor %}
    </div>
</div>
{% endblock %}
