version: "3.9"  # optional since v1.27.0

x-monitor: &default-app
  build: ./django
  env_file:
   - ./django/monitor/.env
  volumes:
    - ./django/monitor/:/opt/monitor/
    - ./alertmanager/shared/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    - ./django/requirements.txt:/opt/requirements.txt:ro
  environment:
    - SECRET_KEY=${DJANGO_SECRET_KEY}
    - DOMAIN=${DOMAIN}
    - PORT=${PORT}
    - DEBUG=${DEBUG}
    - WEBAUTH_USERNAME=${WEBAUTH_USERNAME}
    - WEBAUTH_PASSWORD=${WEBAUTH_PASSWORD}
    - ALERT_MANAGER_PROTOCOL=${ALERT_MANAGER_PROTOCOL:-http}
    - ALERT_MANAGER_PORT=${ALERT_MANAGER_PORT:-80}
  links:
    - alertmanager

services:
  nginx:
    container_name: monitor_nginx
    build: ./nginx
    ports:
      - "${PORT:-8000}:80"
      - "${PORT_HTTPS:-8443}:443"
    volumes:
      - ./data/log:/var/log
      - ./data/log/nginx:/var/log/nginx
      - ./nginx/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf/${NGINX:-local}/:/etc/nginx/conf.d/
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - ./.htpasswd:/etc/nginx/.htpasswd/.htpasswd:ro
      - ./nginx/geolite/GeoLite2-Country.mmdb:/etc/GeoLite2-Country.mmdb
      - ./nginx/geolite/GeoLite2-City.mmdb:/etc/GeoLite2-City.mmdb
      - ./django/monitor/staticfiles:/etc/staticfiles
      - ./docs:/docs
    links:
      - alertmanager
      - grafana
      - django
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
  certbot:
    container_name: monitor_certbot
    image: certbot/certbot
    volumes:  
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
  grafana:
    container_name: monitor_grafana
    image: grafana/grafana:8.2.0
    environment:
      - GF_INSTALL_PLUGINS=grafana-worldmap-panel 0.3.2
      - GF_SERVER_ROOT_URL=/grafana/
      - GR_SERVER_SERVE_FROM_SUB_PATH=True
    user: root
    volumes:
      - ./data/log:/var/log
      - ./data/grafana:/var/lib/grafana
  alertmanager:
    container_name: monitor_alertmanager
    image: quay.io/prometheus/alertmanager
    volumes:
      - ./alertmanager/shared/alertmanager.yml:/etc/alertmanager/alertmanager.yml
  django:
    <<: *default-app
    container_name: monitor_django
    profiles:
      - dev
    command: "python3 manage.py runserver 0.0.0.0:8000"
  django:
    <<: *default-app
    container_name: monitor_django
    profiles:
      - prod
    command: "gunicorn -b 0.0.0.0:8000 monitor.wsgi"
    # command: "python3 manage.py runserver 0.0.0.0:8000"
  tailwind:
    <<: *default-app
    container_name: monitor_tailwind
    command: "python3 manage.py tailwind start"
    profiles:
      - dev
    ports:
      - "8383:8383"
  sphinx:
    container_name: monitor_sphinx
    build: ./sphinx
    command: "sphinx-reload /docs"
    profiles:
      - dev
    volumes:
      - ./docs:/docs
      - ./sphinx/requirements.txt:/requirements.txt
    ports:
      - "5500:5500"
  promtail:
    container_name: monitor_promtail
    image: grafana/promtail:2.3.0
    volumes:
      - ./data/log:/var/log
      - ./promtail/promtail-config.yaml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml

volumes:
  logvolume01: {}
